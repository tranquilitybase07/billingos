# BillingOS Folder Structure

## Repository Strategy: Hybrid Approach

**Decision:** Monorepo for the main application + Separate repository for SDK

### Why This Structure?

We chose a hybrid approach after careful consideration of scaling to 20+ developers and 10,000+ SDK users:

1. **Frontend/Backend are tightly coupled** → They deploy together, share types, worked on by same team
2. **SDK is a product, not internal code** → Needs independent versioning, can be open-sourced, community contributions
3. **Industry standard** → Stripe, Paddle, and Supabase use this pattern
4. **Scale-ready from day 1** → No painful migration later when SDK has thousands of users

**Cost of starting wrong:** 3-4 weeks to extract SDK + risk of breaking customers

---

## Repository 1: Main Application (Monorepo)

**Location:** `/Users/ankushkumar/Code/billingos/`

```
billingos/
├── apps/
│   ├── web/                      # Next.js frontend (Vercel)
│   └── api/                      # NestJS backend (Railway)
│
├── packages/
│   └── shared/
│       └── types/
│           └── database.ts       # Supabase-generated types (NEVER published)
│
├── supabase/
│   ├── migrations/               # Database schema migrations
│   └── config.toml
│
├── docs/
│   ├── backend-architecture.md   # Backend tech decisions
│   └── folder-structure.md       # This file
│
├── package.json                  # Workspace config (pnpm)
└── pnpm-workspace.yaml
```

### What Lives Here

| Directory | Purpose | Access |
|-----------|---------|--------|
| `apps/web` | Customer-facing Next.js app | Public (deployed to Vercel) |
| `apps/api` | NestJS backend API | Private (deployed to Railway) |
| `packages/shared/types` | Supabase-generated database types | Internal only (never published) |
| `supabase/migrations` | Database schema (SQL) | Internal only |
| `docs/` | Architecture decisions, onboarding | Internal only |

### Key Principles

**✅ DO:**
- Share types between `apps/web` and `apps/api` via `@shared/types`
- Keep frontend and backend in sync (atomic commits)
- Deploy frontend and backend together
- Use Supabase-generated types for internal code

**❌ DON'T:**
- Publish internal types to npm
- Expose database schema to customers
- Mix SDK code with internal app code

---

## Repository 2: SDK (Separate Repo)

**Location:** `/Users/ankushkumar/Code/billingos-sdk/` (to be created)

```
billingos-sdk/
├── src/
│   ├── client.ts                 # Main SDK client
│   ├── types.ts                  # Public API types (customer-facing)
│   ├── hooks/                    # React hooks (useSubscription, etc.)
│   └── components/               # React components (optional)
│
├── examples/
│   └── nextjs/                   # Example Next.js integration
│
├── docs/
│   └── README.md                 # SDK documentation
│
└── package.json                  # Published as @billingos/sdk
```

### What Lives Here

| Directory | Purpose | Published? |
|-----------|---------|------------|
| `src/` | SDK source code | ✅ Yes (npm) |
| `src/types.ts` | Public API types (NOT database types) | ✅ Yes (npm) |
| `examples/` | Integration examples | ✅ Yes (GitHub) |
| `docs/` | SDK usage docs | ✅ Yes (GitHub) |

### Key Principles

**✅ DO:**
- Define SDK types based on API responses (intentional, manual)
- Version independently (v1.0.0, v2.0.0)
- Accept community contributions
- Maintain backward compatibility

**❌ DON'T:**
- Import types from main monorepo
- Expose internal implementation details
- Auto-generate types from database schema

---

## Type Flow: How Types Stay in Sync

**Critical Understanding:** We have TWO separate type systems (by design).

### Internal Types (Monorepo - Private)

```typescript
// Generated by: supabase gen types typescript
// File: packages/shared/types/database.ts

type SubscriptionRow = {
  id: string
  stripe_subscription_id: string      // Internal Stripe ID
  stripe_customer_id: string          // Internal
  customer_id: string                 // Foreign key
  metadata: Record<string, any>       // May contain secrets
  proration_date: Date | null         // Internal Stripe detail
  // ... 20+ internal fields
}
```

**Used by:** Backend and Frontend (internal code only)
**Never exposed to:** Customers, SDK users, public

### SDK Types (Separate Repo - Public)

```typescript
// Defined manually based on API contract
// File: billingos-sdk/src/types.ts

export type Subscription = {
  id: string
  status: 'active' | 'canceled' | 'past_due' | 'trialing'
  currentPeriodEnd: Date
  plan: {
    id: string
    name: string
    price: number
  }
}
```

**Used by:** Customers integrating BillingOS
**Published to:** npm as part of `@billingos/sdk`

### The Transformation Layer (Backend API)

```
Database (Postgres)
    ↓
Supabase generates types → packages/shared/types/database.ts
    ↓
Backend uses internal types
    ↓
Backend API transforms & returns public data
    ↓
SDK defines types based on API responses
    ↓
Customers use SDK types
```

**Why this separation is GOOD:**
- Security: No internal data exposed
- API design: Intentional, not accidental
- Versioning: SDK can evolve independently
- Breaking changes: Explicit (major version bump)

---

## When Adding a New Feature

**Example:** Add trial days to subscriptions

### Step 1: Database Migration (Monorepo)
```sql
-- supabase/migrations/20240101_add_trial_days.sql
ALTER TABLE subscriptions ADD COLUMN trial_days INTEGER;
```

### Step 2: Regenerate Types (Monorepo)
```bash
cd billingos
supabase gen types typescript --local > packages/shared/types/database.ts
```

### Step 3: Backend Uses Types (Monorepo)
```typescript
// apps/api/subscriptions/subscription.service.ts
const sub = await supabase.from('subscriptions').select('*').single()
console.log(sub.trial_days) // ✅ TypeScript knows this exists
```

### Step 4: Update API Response (Monorepo)
```typescript
// apps/api/subscriptions/subscription.controller.ts
return {
  id: sub.id,
  status: sub.status,
  trialDaysRemaining: sub.trial_days // Transform for public API
}
```

### Step 5: Update SDK Types (Separate Repo)
```typescript
// billingos-sdk/src/types.ts
export type Subscription = {
  // ... existing fields
  trialDaysRemaining?: number  // ← Add manually
}
```

### Step 6: Update Frontend (Monorepo)
```typescript
// apps/web/components/SubscriptionCard.tsx
import { Database } from '@shared/types/database'
// Use internal types with RLS
```

**Notice:** Internal and SDK types stay in sync manually (intentional).

---

## Monorepo Setup (pnpm Workspaces)

**File:** `pnpm-workspace.yaml`
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

**File:** `package.json` (root)
```json
{
  "name": "billingos",
  "private": true,
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "db:types": "supabase gen types typescript --local > packages/shared/types/database.ts"
  },
  "devDependencies": {
    "turbo": "latest"
  }
}
```

**File:** `apps/web/package.json`
```json
{
  "name": "web",
  "dependencies": {
    "@shared/types": "workspace:*"
  }
}
```

**File:** `apps/api/package.json`
```json
{
  "name": "api",
  "dependencies": {
    "@shared/types": "workspace:*"
  }
}
```

---

## SDK Repository Setup

**File:** `billingos-sdk/package.json`
```json
{
  "name": "@billingos/sdk",
  "version": "1.0.0",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

**No dependency on monorepo.**

---

## Development Workflow

### Working on Internal Features

```bash
# Clone main repo
git clone git@github.com:yourorg/billingos.git
cd billingos

# Install dependencies
pnpm install

# Run both frontend and backend
pnpm dev

# Generate database types after migration
pnpm db:types
```

### Working on SDK

```bash
# Clone SDK repo
git clone git@github.com:yourorg/billingos-sdk.git
cd billingos-sdk

# Install dependencies
npm install

# Run in dev mode
npm run dev

# Publish to npm (after version bump)
npm publish
```

---

## Deployment

| Component | Repo | Platform | Trigger |
|-----------|------|----------|---------|
| Frontend | `billingos/apps/web` | Vercel | Push to main |
| Backend | `billingos/apps/api` | Railway | Push to main |
| SDK | `billingos-sdk` | npm | Manual publish (after version tag) |

---

## Why Not Full Monorepo?

**We considered putting SDK in monorepo but decided against it:**

| Concern | Why Separate SDK Wins |
|---------|----------------------|
| Can't open-source SDK | Backend secrets would be exposed |
| SDK versioning unclear | Is it v1.2.3 (app) or v2.0.1 (SDK)? |
| Customer issues mixed | GitHub issues for SDK vs internal bugs |
| Breaking changes risky | SDK refactor could affect internal code |
| No dedicated SDK team | Everyone touches everything |

**Migration cost if we start wrong:** 3-4 weeks + customer migration pain

---

## Why Not Polyrepo (All Separate)?

**We considered 3 separate repos but decided against it:**

| Concern | Why Monorepo for App Wins |
|---------|--------------------------|
| Type duplication | Frontend/backend need same database types |
| Breaking changes | Require 3 PRs across 3 repos |
| Atomic commits | Can't commit frontend + backend together |
| Artificial separation | Frontend/backend deploy together anyway |

**Over-engineering with no benefit.**

---

## Future Considerations

### When to Migrate to Polyrepo?

**Only if:**
- Frontend and backend teams are completely separate (10+ people each)
- Frontend and backend have different release cycles
- Different tech leads for each

**For a 4-20 person team:** Monorepo is correct.

### When to Add More SDK Repos?

**If you build SDKs for other languages:**
- `billingos-sdk-js` (React/Next.js)
- `billingos-sdk-python` (Django/Flask)
- `billingos-sdk-php` (Laravel)

Each gets its own repo with independent versioning.

---

## Key Takeaways

1. **Hybrid structure** = Monorepo for app + Separate SDK repo
2. **Internal types** = Supabase-generated (never published)
3. **SDK types** = Manually defined (public API contract)
4. **Two type systems** = By design (security + intentional API)
5. **No shared types package** = SDK defines its own types
6. **Scale-ready from day 1** = No migration pain in 2 years

---

## New Developer Onboarding

**To work on the main app:**
1. Clone `billingos` monorepo
2. Run `pnpm install`
3. Run `pnpm dev` (starts both frontend and backend)
4. Import types from `@shared/types`

**To work on the SDK:**
1. Clone `billingos-sdk` repo
2. Run `npm install`
3. Define types based on API docs
4. Never import from main monorepo

**To understand the system:**
1. Read `docs/backend-architecture.md` (tech stack decisions)
2. Read `docs/folder-structure.md` (this file)
3. Look at `supabase/migrations` (database schema)
4. Check API responses (basis for SDK types)

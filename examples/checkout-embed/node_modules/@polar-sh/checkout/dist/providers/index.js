"use client";import{AlreadyActiveSubscriptionError as A}from"@polar-sh/sdk/models/errors/alreadyactivesubscriptionerror.js";import{HTTPValidationError as U}from"@polar-sh/sdk/models/errors/httpvalidationerror";import{NotOpenCheckout as V}from"@polar-sh/sdk/models/errors/notopencheckout.js";import{PaymentError as q}from"@polar-sh/sdk/models/errors/paymenterror.js";import{PaymentNotReady as N}from"@polar-sh/sdk/models/errors/paymentnotready.js";import{TrialAlreadyRedeemed as _}from"@polar-sh/sdk/models/errors/trialalreadyredeemed";import{createContext as Q,useCallback as F,useContext as X,useState as S}from"react";import{useForm as Z}from"react-hook-form";var g=(c,u,l=1,m)=>{c.forEach(t=>{let o=t.loc.slice(l);m&&m.includes(o[0])&&(o=o.slice(1));for(let n=0;n<o.length&&!(!Number.isInteger(o[n])&&(o[n]=o[n].replace(/_([a-z])/g,d=>d[1].toUpperCase()),o[n]==="customFieldData"));n++);u(o.join("."),{type:t.type,message:t.msg})})};import{PolarCore as K}from"@polar-sh/sdk/core";import{checkoutsClientConfirm as O}from"@polar-sh/sdk/funcs/checkoutsClientConfirm";import{checkoutsClientGet as T}from"@polar-sh/sdk/funcs/checkoutsClientGet";import{checkoutsClientUpdate as H}from"@polar-sh/sdk/funcs/checkoutsClientUpdate";import{createContext as L,useCallback as v,useContext as j,useEffect as G,useMemo as M,useState as W}from"react";import{jsx as J}from"react/jsx-runtime";var Y=()=>{throw new Error("You forgot to wrap your component in <CheckoutProvider>.")},x=L(Y),z=({clientSecret:c,serverURL:u,server:l,children:m})=>{let t=M(()=>new K({server:l,serverURL:u}),[l,u]),[o,n]=W(null);G(()=>{T(t,{clientSecret:c}).then(({ok:a,value:r,error:k})=>{if(a)n(r);else throw k})},[t,c]);let d=v(async()=>{let a=await T(t,{clientSecret:c});return a.ok&&n(a.value),a},[t,c]),C=v(async a=>{let r=await H(t,{clientSecret:c,checkoutUpdatePublic:a});return r.ok&&n(r.value),r},[t,c]),h=v(async a=>{let r=await O(t,{clientSecret:c,checkoutConfirmStripe:a});return r.ok&&n(r.value),r},[t,c]);return o?J(x.Provider,{value:{checkout:o,refresh:d,update:C,confirm:h,client:t},children:m}):null},w=()=>j(x);import{jsx as re}from"react/jsx-runtime";var $=()=>{throw new Error("You forgot to wrap your component in <CheckoutFormProvider>.")},R=Q($),ee=({children:c})=>{let{checkout:u,update:l,confirm:m}=w(),[t,o]=S(!1),[n,d]=S(),[C,h]=S(!1),a=Z({defaultValues:{...u,customerBillingAddress:u.customerBillingAddress,discountCode:u.discount?u.discount.code:void 0,allowTrial:void 0},shouldUnregister:!0}),{setError:r}=a,k=F(async i=>{h(!0);let{ok:p,value:f,error:e}=await l(i).finally(()=>{h(!1)});if(p)return f;throw e instanceof U?g(e.detail||[],r):(e instanceof A||e instanceof V||e instanceof q||e instanceof N)&&r("root",{message:e.detail}),e},[l,r]),P=F(async i=>{let{ok:p,value:f,error:e}=await m(i);if(p)return f;throw e instanceof U?g(e.detail||[],r):(e instanceof A||e instanceof V||e instanceof q||e instanceof N||e instanceof _)&&(r("root",{message:e.detail}),e instanceof _&&await k({allowTrial:!1})),e},[m,r]),D=F(async(i,p,f)=>{if(o(!0),!u.isPaymentFormRequired){d("Processing order...");try{return await P(i)}catch(s){throw s}finally{o(!1)}}if(!p||!f)throw o(!1),new Error("Stripe elements not provided");d("Processing payment");let{error:e}=await f.submit();if(e)throw e.type!=="validation_error"&&r("root",{message:e.message}),o(!1),new Error(e.message);let E,y;try{let s=await p.createConfirmationToken({elements:f,params:{payment_method_data:{billing_details:{name:i.customerName,email:i.customerEmail,address:{line1:i.customerBillingAddress?.line1||null,line2:i.customerBillingAddress?.line2||null,postal_code:i.customerBillingAddress?.postalCode||null,city:i.customerBillingAddress?.city||null,state:i.customerBillingAddress?.state||null,country:i.customerBillingAddress?.country||null},phone:null}}}});E=s.confirmationToken,y=s.error}catch(s){throw o(!1),s}if(!E||y)throw r("root",{message:y?.message||"Failed to create confirmation token, please try again later."}),o(!1),new Error("Failed to create confirmation token, please try again later.");let b;try{b=await P({...i,confirmationTokenId:E.id})}catch(s){throw o(!1),s}d("Payment successful! Getting your products ready...");let{intent_status:I,intent_client_secret:B}=b.paymentProcessorMetadata;if(I==="requires_action"){let{error:s}=await p.handleNextAction({clientSecret:B});if(s)throw o(!1),r("root",{message:s.message}),new Error(s.message)}return o(!1),b},[u,r,P]);return re(R.Provider,{value:{checkout:u,form:a,update:k,confirm:D,loading:t,loadingLabel:n,isUpdatePending:C},children:c})},oe=()=>X(R);export{x as CheckoutContext,R as CheckoutFormContext,ee as CheckoutFormProvider,z as CheckoutProvider,w as useCheckout,oe as useCheckoutForm};

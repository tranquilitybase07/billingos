"use strict";"use client";var S=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var X=(i,o)=>{for(var l in o)S(i,l,{get:o[l],enumerable:!0})},Z=(i,o,l,p)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of J(o))!Q.call(i,t)&&t!==l&&S(i,t,{get:()=>o[t],enumerable:!(p=z(o,t))||p.enumerable});return i};var $=i=>Z(S({},"__esModule",{value:!0}),i);var re={};X(re,{CheckoutContext:()=>E,CheckoutFormContext:()=>b,CheckoutFormProvider:()=>L,CheckoutProvider:()=>K,useCheckout:()=>y,useCheckoutForm:()=>j});module.exports=$(re);var A=require("@polar-sh/sdk/models/errors/alreadyactivesubscriptionerror.js"),U=require("@polar-sh/sdk/models/errors/httpvalidationerror"),V=require("@polar-sh/sdk/models/errors/notopencheckout.js"),q=require("@polar-sh/sdk/models/errors/paymenterror.js"),N=require("@polar-sh/sdk/models/errors/paymentnotready.js"),_=require("@polar-sh/sdk/models/errors/trialalreadyredeemed"),d=require("react"),H=require("react-hook-form");var R=(i,o,l=1,p)=>{i.forEach(t=>{let r=t.loc.slice(l);p&&p.includes(r[0])&&(r=r.slice(1));for(let u=0;u<r.length&&!(!Number.isInteger(r[u])&&(r[u]=r[u].replace(/_([a-z])/g,f=>f[1].toUpperCase()),r[u]==="customFieldData"));u++);o(r.join("."),{type:t.type,message:t.msg})})};var D=require("@polar-sh/sdk/core"),I=require("@polar-sh/sdk/funcs/checkoutsClientConfirm"),T=require("@polar-sh/sdk/funcs/checkoutsClientGet"),B=require("@polar-sh/sdk/funcs/checkoutsClientUpdate"),c=require("react"),O=require("react/jsx-runtime"),ee=()=>{throw new Error("You forgot to wrap your component in <CheckoutProvider>.")},E=(0,c.createContext)(ee),K=({clientSecret:i,serverURL:o,server:l,children:p})=>{let t=(0,c.useMemo)(()=>new D.PolarCore({server:l,serverURL:o}),[l,o]),[r,u]=(0,c.useState)(null);(0,c.useEffect)(()=>{(0,T.checkoutsClientGet)(t,{clientSecret:i}).then(({ok:m,value:n,error:P})=>{if(m)u(n);else throw P})},[t,i]);let f=(0,c.useCallback)(async()=>{let m=await(0,T.checkoutsClientGet)(t,{clientSecret:i});return m.ok&&u(m.value),m},[t,i]),g=(0,c.useCallback)(async m=>{let n=await(0,B.checkoutsClientUpdate)(t,{clientSecret:i,checkoutUpdatePublic:m});return n.ok&&u(n.value),n},[t,i]),C=(0,c.useCallback)(async m=>{let n=await(0,I.checkoutsClientConfirm)(t,{clientSecret:i,checkoutConfirmStripe:m});return n.ok&&u(n.value),n},[t,i]);return r?(0,O.jsx)(E.Provider,{value:{checkout:r,refresh:f,update:g,confirm:C,client:t},children:p}):null},y=()=>(0,c.useContext)(E);var G=require("react/jsx-runtime"),oe=()=>{throw new Error("You forgot to wrap your component in <CheckoutFormProvider>.")},b=(0,d.createContext)(oe),L=({children:i})=>{let{checkout:o,update:l,confirm:p}=y(),[t,r]=(0,d.useState)(!1),[u,f]=(0,d.useState)(),[g,C]=(0,d.useState)(!1),m=(0,H.useForm)({defaultValues:{...o,customerBillingAddress:o.customerBillingAddress,discountCode:o.discount?o.discount.code:void 0,allowTrial:void 0},shouldUnregister:!0}),{setError:n}=m,P=(0,d.useCallback)(async s=>{C(!0);let{ok:h,value:k,error:e}=await l(s).finally(()=>{C(!1)});if(h)return k;throw e instanceof U.HTTPValidationError?R(e.detail||[],n):(e instanceof A.AlreadyActiveSubscriptionError||e instanceof V.NotOpenCheckout||e instanceof q.PaymentError||e instanceof N.PaymentNotReady)&&n("root",{message:e.detail}),e},[l,n]),v=(0,d.useCallback)(async s=>{let{ok:h,value:k,error:e}=await p(s);if(h)return k;throw e instanceof U.HTTPValidationError?R(e.detail||[],n):(e instanceof A.AlreadyActiveSubscriptionError||e instanceof V.NotOpenCheckout||e instanceof q.PaymentError||e instanceof N.PaymentNotReady||e instanceof _.TrialAlreadyRedeemed)&&(n("root",{message:e.detail}),e instanceof _.TrialAlreadyRedeemed&&await P({allowTrial:!1})),e},[p,n]),M=(0,d.useCallback)(async(s,h,k)=>{if(r(!0),!o.isPaymentFormRequired){f("Processing order...");try{return await v(s)}catch(a){throw a}finally{r(!1)}}if(!h||!k)throw r(!1),new Error("Stripe elements not provided");f("Processing payment");let{error:e}=await k.submit();if(e)throw e.type!=="validation_error"&&n("root",{message:e.message}),r(!1),new Error(e.message);let x,w;try{let a=await h.createConfirmationToken({elements:k,params:{payment_method_data:{billing_details:{name:s.customerName,email:s.customerEmail,address:{line1:s.customerBillingAddress?.line1||null,line2:s.customerBillingAddress?.line2||null,postal_code:s.customerBillingAddress?.postalCode||null,city:s.customerBillingAddress?.city||null,state:s.customerBillingAddress?.state||null,country:s.customerBillingAddress?.country||null},phone:null}}}});x=a.confirmationToken,w=a.error}catch(a){throw r(!1),a}if(!x||w)throw n("root",{message:w?.message||"Failed to create confirmation token, please try again later."}),r(!1),new Error("Failed to create confirmation token, please try again later.");let F;try{F=await v({...s,confirmationTokenId:x.id})}catch(a){throw r(!1),a}f("Payment successful! Getting your products ready...");let{intent_status:W,intent_client_secret:Y}=F.paymentProcessorMetadata;if(W==="requires_action"){let{error:a}=await h.handleNextAction({clientSecret:Y});if(a)throw r(!1),n("root",{message:a.message}),new Error(a.message)}return r(!1),F},[o,n,v]);return(0,G.jsx)(b.Provider,{value:{checkout:o,form:m,update:P,confirm:M,loading:t,loadingLabel:u,isUpdatePending:g},children:i})},j=()=>(0,d.useContext)(b);0&&(module.exports={CheckoutContext,CheckoutFormContext,CheckoutFormProvider,CheckoutProvider,useCheckout,useCheckoutForm});
